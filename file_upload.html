<!DOCTYPE html>
<html lang="en">
  <head>
    <title>CSS Template</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <style>
      <!-- .drag-over {
        background-color: #ff0;
      }
      -- > .thumb {
        width: 200px;
        padding: 5px;
        float: left;
      }
      .thumb > img {
        width: 100%;
      }
      .thumb > progress {
        width: 100%;
      }
      .thumb > .close {
        position: absolute;
        background-color: red;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <input type="button" id="btnSubmit" value="업로드" />
    <div
      id="drop"
      style="border: 1px solid black; width: 800px; height: 300px; padding: 3px"
    >
      여기로 drag & drop
      <div id="thumbnails">
        <progress
          id="progressBar"
          value="0"
          max="100"
          style="width: 100%"
        ></progress>
      </div>
    </div>
    <script>
      var uploadFiles = [];
      var $drop = $("#drop");
      $drop
        .on("dragenter", function (e) {
          //드래그 요소가 들어왔을떄
          $(this).addClass("drag-over");
        })
        .on("dragleave", function (e) {
          //드래그 요소가 나갔을때
          $(this).removeClass("drag-over");
        })
        .on("dragover", function (e) {
          e.stopPropagation();
          e.preventDefault();
        })
        .on("drop", function (e) {
          e.preventDefault();
          $(this).removeClass("drag-over");
          var files = e.originalEvent.dataTransfer.files;
          for (var i = 0; i < files.length; i++) {
            var file = files[i];
            console.log(file);
            var size = uploadFiles.push(file);
            preview(file, size - 1);
          }
        });

      function preview(file, idx) {
        var reader = new FileReader();
        reader.onload = (function (f, idx) {
          return function (e) {
            console.log(e);
            console.log(e.target);
            console.log(e.target.result);
            var $div = $(
              '<div class="thumb"> \
                <progress value="0" max="100" ></progress> \
                <div class="close" data-idx="' +
                idx +
                '">X</div> \
                <img src="' +
                e.target.result +
                '" title="' +
                escape(f.name) +
                '"/> \
                </div>'
            );
            console.log(`f.target - ${f.target}`);
            console.log(`f - ${f}`);
            $("#thumbnails").append($div);
            f.target = $div;
          };
        })(file, idx);
        console.log(`file - ${file}`);
        reader.readAsDataURL(file);
        console.log(reader.result);
      }

      var mode = 1; //0:여러 파일을 한번에 업로드, 1:여러 파일을 각각 차례대로 업로드
      var uploadStatus = {
        total: 0,
        count: 0,
      };

      $("#btnSubmit").on("click", function (e) {
        if (mode == 0) groupUpload();
        else if (mode == 1) {
          $.each(uploadFiles, function (i, file) {
            if (file.upload != "disable") uploadStatus.total++;
          });
          eachUpload();
        }
      });

      //전체파일 한번에 업로드
      function groupUpload() {
        var formData = new FormData();
        $.each(uploadFiles, function (i, file) {
          if (file.upload != "disable")
            formData.append("upload-file", file, file.name);
        });
        $.ajax({
          url: "/api/etc/file/upload",
          data: formData,
          type: "post",
          contentType: false,
          processData: false,
          xhr: function () {
            //XMLHttpRequest 재정의 가능
            var xhr = $.ajaxSettings.xhr();
            xhr.upload.onprogress = function (e) {
              //progress 이벤트 리스너 추가
              var percent = (e.loaded * 100) / e.total;
              setProgress(percent);
            };
            return xhr;
          },
          success: function (ret) {
            alert("완료");
          },
        });
      }

      //개별 파일 업로드
      function eachUpload() {
        var file = uploadFiles.shift();
        if (!file) {
          setTimeout(alert.bind(null, "완료"), 300);
          return;
        }
        if (file.upload == "disable") {
          eachUpload();
          return;
        }
        var formData = new FormData();
        formData.append("upload-file", file, file.name);
        var $selfProgress = file.target.find("progress"); //File 객체에 저장해둔 프리뷰 DOM의 progress 요소를 찾는다.
        $.ajax({
          url: "/api/etc/file/upload",
          data: formData,
          type: "post",
          contentType: false,
          processData: false,
          xhr: function () {
            //XMLHttpRequest 재정의 가능
            var xhr = $.ajaxSettings.xhr();
            xhr.upload.onprogress = function (e) {
              //progress 이벤트 리스너 추가
              var percent = (e.loaded * 100) / e.total;
              $selfProgress.val(percent); //개별 파일의 프로그레스바 진행
            };
            return xhr;
          },
          success: function (ret) {
            uploadStatus.count++;
            setProgress((uploadStatus.count / uploadStatus.total) * 100); //전체 프로그레스바 진행
            setTimeout(eachUpload, 500); //다음 파일 업로드
          },
        });
      }

      var $progressBar = $("#progressBar");
      function setProgress(per) {
        $progressBar.val(per);
      }

      $("#thumbnails").on("click", ".close", function (e) {
        var $target = $(e.target);
        var idx = $target.attr("data-idx");
        uploadFiles[idx].upload = "disable";
        $target.parent().remove();
      });
    </script>
  </body>
</html>
